#!/bin/sh
cd "$(dirname -- "$(readlink -f -- "$0"; )")"
export INSTALLSCRDIR="$PWD"

sudo apt-get install --no-install-recommends --no-install-suggests \
autotools-dev automake libtool gettext gettext-base gettext-el gnulib autopoint \
xserver-xorg x11-apps twm xserver-xorg-dev libfontconfig-dev \
libxrender-dev libxcomposite-dev libxdamage-dev libxfixes-dev libxext-dev libx11-dev \
libsm-dev libice-dev libxrandr-dev libxft-dev libxpm-dev libjpeg-dev \
libpng-dev libfontconfig1-dev libxinerama-dev libfribidi-dev libimlib2-dev xterm \
x11-utils xinit intltool intltool-debian libxcb-util-dev libx11-xcb-dev \
build-essential libfox-1.6-dev psmisc libxtst-dev libserialport-dev \
libpci-dev feh tk imagemagick libgtk2.0-dev tk-tktray xxkb x11-xserver-utils \
bc alsa-utils xfonts-cronyx* idesk gtk2-engines \
|| exit


if [ "$ONLYTOOLS" -eq 1 ]; then
	exit
fi


simplebuild()
{
	(
	set -e
	cd "$1"
	make clean
	make -j$(nproc)
	sudo make install
	set +e
	) || exit

}



simplebuild i2klibs/ini
simplebuild i2klibs/branding
simplebuild i2klibs/comctl32
simplebuild games/winmine
simplebuild mmc/devmgmt
simplebuild ice2kver
simplebuild batmeter
simplebuild shutdown
simplebuild msgina
simplebuild shell/hotplug
simplebuild shell/backmgr
simplebuild control/sysdm
simplebuild control/desk

#(
#cd icewm-dir/programs/ice2krun
#./compile.sh
#)

(
cd icewm-3.3.1
libtoolize --force
aclocal
autoheader
autoupdate
automake --add-missing --force-missing --copy --foreign
autoreconf -vif
set -e
./configure
make clean
make -j$(nproc)
sudo make install
set +e
) || exit

(
cd xfe-*

aclocal
autoheader
autoupdate
automake --add-missing --force-missing --copy --foreign
autoreconf
set -e
./configure
make clean
make -j$(nproc)
sudo make install
set +e
) || exit

(
cd yad-*

aclocal
autoheader
autoupdate
automake --add-missing --force-missing --copy --foreign
autoreconf
set -e
./configure --with-gtk=gtk2
make clean
make -j$(nproc)
sudo make install
set +e
) || exit

(
cd cbatticon

make clean
make
sudo make install
) || exit



mv ~/.icewm ~/.icewm-old
cp -rf icewm-dir ~/.icewm
cp -rf .config ~/
cp -rf .foxrc ~/
cp -rf .idesktop ~/
cp -rf .icons ~/
cp -rf .themes ~/
cp .ideskrc ~/
cp .Xresources ~/
cp .gtkrc-2.0 ~/
cp .Xsession ~/
ln -s "$HOME/.Xsession" "$HOME/.xinitrc"

sudo mkdir -p /usr/share/fonts/X11/misc
sudo mkdir -p /usr/share/fonts/truetype

sudo cp winvga-12.pcf /usr/share/fonts/X11/misc

# from wine
sudo cp tahoma*.ttf /usr/share/fonts/truetype
sudo cp tahoma*.pcf.gz /usr/share/fonts/X11/100dpi

sudo update-fonts-dir misc
sudo update-fonts-alias misc
sudo update-fonts-dir 100dpi
sudo update-fonts-alias 100dpi

echo "$USER ALL=(ALL) NOPASSWD: /usr/sbin/poweroff, /sbin/poweroff, /usr/sbin/reboot, /sbin/reboot, /sbin/shutdown, /sbin/pm-suspend, /usr/sbin/pm-suspend
$USER ALL=(ALL) NOPASSWD: /usr/bin/cpupower
$USER ALL=(ALL) NOPASSWD: /usr/bin/tee /sys/class/backlight/intel_backlight/brightness
$USER ALL=(ALL) NOPASSWD: /sbin/iwlist
$USER ALL=(ALL) NOPASSWD: /usr/bin/eject" | sudo sh -c 'cat >> /dev/sudoers'

echo
echo "installation successful!!!!"

a=1
if groups | grep -v -q input; then
	echo
	echo "if this is a fresh install, you probably want to add yourself"
	echo "to the input group. else there is a high chance input won't"
	echo "work."
	echo

	while [ $a -eq 1 ]; do
		echo -n "add $USER to input group? [Y/N] "

		read line;

		line="$(echo -n "$line" | tr A-Z a-z)"

		if [ "$line" = "y" ]; then
			a=0
			sudo usermod -aG input "$USER" && echo "done!!!"
		elif [ "$line" = "n" ]; then
			echo "ok..."
			a=0
		fi
	done
fi
a=1
if groups | grep -v -q audio; then

	echo
	echo ======================================================
	echo

	echo "unless you will install pulseaudio/pipewire or already have it"
	echo "installed, you should probably add yourself to the audio group"
	echo "or you wont have working audio."
	echo

	while [ $a -eq 1 ]; do
		echo -n "add $USER to audio group? [Y/N] "

		read line;

		line="$(echo -n "$line" | tr A-Z a-z)"

		if [ "$line" = "y" ]; then
			a=0
			sudo usermod -aG audio "$USER" && echo "done!!!"
		elif [ "$line" = "n" ]; then
			echo "ok..."
			a=0
		fi
	done
fi

echo
echo "if you want to launch ice2k.sys..."
echo
echo "if you had to enable groups earlier, you have to logout first."
echo "run exit, log back in and then you can run startx!"
echo
echo "if not"
echo
echo "'cd ~ && startx'"
echo

